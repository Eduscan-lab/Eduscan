<!DOCTYPE html>
<html>
<head>
  <title>Student Attendance System</title>
  <meta charset="UTF-8">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: Arial; background: #f4f4f4; padding: 20px; }
    .box { max-width: 400px; margin: 20px auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
    input, button, select { width: 100%; margin: 10px 0; padding: 10px; font-size: 16px; }
    .hide { display: none; }
    #qrcode { margin: 10px auto; width: 200px; height: 200px; }
    .log { margin-top: 20px; padding: 10px; background: #eaeaea; border-radius: 5px; max-height: 300px; overflow-y: auto; }
  </style>
</head>
<body>

<!-- Student Registration -->
<div class="box" id="registerBox">
  <h2>📝 Student Register</h2>
  <input id="regUser" placeholder="Username">
  <input id="regPass" type="password" placeholder="Password">
  <input id="regName" placeholder="Full Name">
  <input id="regStrand" placeholder="Track and Strand (e.g., STEM)">
  <button onclick="register()">Register</button>
  <p>Already have an account? <a href="#" onclick="switchView('loginBox')">Login here</a></p>
</div>

<!-- Student Login -->
<div class="box hide" id="loginBox">
  <h2>🔐 Student Login</h2>
  <input id="loginUser" placeholder="Username">
  <input id="loginPass" type="password" placeholder="Password">
  <button onclick="studentLogin()">Login</button>
  <p>Admin? <a href="#" onclick="switchView('adminBox')">Login here</a></p>
</div>

<!-- Student Dashboard with QR -->
<div class="box hide" id="studentDashboard">
  <h2>🎓 Welcome, <span id="studentName"></span></h2>
  <p><strong>Track & Strand:</strong> <span id="studentStrand"></span></p>
  <div id="qrcode"></div>
  <button onclick="logout()">Logout</button>
</div>

<!-- Admin Login -->
<div class="box hide" id="adminBox">
  <h2>🛡️ Admin Login</h2>
  <input id="adminUser" placeholder="Admin Username">
  <input id="adminPass" type="password" placeholder="Admin Password">
  <button onclick="adminLogin()">Login</button>
  <p><a href="#" onclick="switchView('loginBox')">Back to Student Login</a></p>
</div>

<!-- Admin QR Scanner -->
<div class="box hide" id="adminPanel">
  <h2>📷 Admin QR Scanner</h2>
  <div id="reader" style="width: 300px; margin:auto;"></div>
  <div class="log" id="logBox">
    <h3>📋 Logs</h3>
    <div id="logs"></div>
  </div>
  <button onclick="logout()">Logout</button>
</div>

<script>
  function switchView(id) {
    document.querySelectorAll('.box').forEach(b => b.classList.add('hide'));
    document.getElementById(id).classList.remove('hide');
  }

  function register() {
    const u = regUser.value.trim();
    const p = regPass.value;
    const n = regName.value.trim();
    const s = regStrand.value.trim();
    if (!u || !p || !n || !s) return alert("Please fill all fields.");
    if (localStorage.getItem("user_" + u)) return alert("Username already exists.");
    const id = "STU" + Date.now();
    const data = { password: p, name: n, strand: s, id };
    localStorage.setItem("user_" + u, JSON.stringify(data));
    alert("Registered! You can now login.");
    switchView('loginBox');
  }

  function studentLogin() {
    const u = loginUser.value.trim();
    const p = loginPass.value;
    const user = JSON.parse(localStorage.getItem("user_" + u));
    if (!user || user.password !== p) return alert("Invalid credentials.");
    localStorage.setItem("currentUser", u);
    showStudentDashboard(user);
  }

  function showStudentDashboard(user) {
    switchView('studentDashboard');
    studentName.textContent = user.name;
    studentStrand.textContent = user.strand;
    new QRCode(document.getElementById("qrcode"), {
      text: user.id,
      width: 200,
      height: 200
    });
  }

  function adminLogin() {
    const u = adminUser.value.trim();
    const p = adminPass.value;
    if (u === "admin" && p === "admin123") {
      localStorage.setItem("adminLogged", "yes");
      switchView('adminPanel');
      startScanner();
      loadLogs();
    } else {
      alert("Invalid admin credentials.");
    }
  }

  function logout() {
    localStorage.removeItem("currentUser");
    localStorage.removeItem("adminLogged");
    location.reload();
  }

  function startScanner() {
    const scanner = new Html5Qrcode("reader");
    scanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        scanner.pause();
        logStudent(decodedText);
        setTimeout(() => scanner.resume(), 2000);
      }
    );
  }

  function logStudent(id) {
    let found = false;
    for (let key in localStorage) {
      if (key.startsWith("user_")) {
        const user = JSON.parse(localStorage.getItem(key));
        if (user.id === id) {
          found = true;
          const time = new Date().toLocaleString();
          const log = `${user.name} (${user.strand}) - ${time}`;
          const logs = JSON.parse(localStorage.getItem("logs") || "[]");
          logs.push(log);
          localStorage.setItem("logs", JSON.stringify(logs));
          loadLogs();
          alert("Logged: " + log);
          break;
        }
      }
    }
    if (!found) alert("Student not found.");
  }

  function loadLogs() {
    const logs = JSON.parse(localStorage.getItem("logs") || "[]");
    document.getElementById("logs").innerHTML = logs.map(l => `<p>${l}</p>`).join('');
  }

  // Auto-login check
  const current = localStorage.getItem("currentUser");
  if (current) {
    const user = JSON.parse(localStorage.getItem("user_" + current));
    showStudentDashboard(user);
  } else if (localStorage.getItem("adminLogged") === "yes") {
    switchView("adminPanel");
    startScanner();
    loadLogs();
  } else {
    switchView("registerBox");
  }
</script>

</body>
</html>