<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Time In/Out System</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .container {
      max-width: 500px;
      width: 100%;
      padding: 20px;
      background: white;
      margin-top: 40px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }
    h2 {
      text-align: center;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #scanner, #adminQR, #logTable, #todayLogs {
      margin-top: 20px;
    }
    .hidden {
      display: none;
    }
    .success {
      animation: flashSuccess 0.4s ease-in-out;
    }
    @keyframes flashSuccess {
      from { background-color: #d4edda; }
      to { background-color: white; }
    }
    @media (max-width: 600px) {
      .container {
        width: 95%;
      }
    }
  </style>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
  <div class="container" id="authContainer">
    <h2>Login / Register</h2>
    <input type="text" id="name" placeholder="Full Name" required />
    <input type="text" id="track" placeholder="Track (e.g., ABM, STEM, etc.)" required />
    <select id="strand">
      <option value="">Select Strand</option>
      <option value="STEM">STEM</option>
      <option value="ABM">ABM</option>
      <option value="HUMSS">HUMSS</option>
      <option value="GAS">GAS</option>
      <option value="ICT">ICT</option>
      <option value="HE">HE</option>
    </select>
    <select id="grade">
      <option value="">Select Grade</option>
      <option value="11">Grade 11</option>
      <option value="12">Grade 12</option>
    </select>
    <input type="password" id="password" placeholder="Password" required />
    <button onclick="register()">Register</button>
    <button onclick="login()">Login</button>
  </div>

  <div class="container hidden" id="studentDashboard">
    <h2>Welcome, <span id="studentName"></span></h2>
    <p>Grade: <span id="studentGrade"></span> | Track/Strand: <span id="studentTrack"></span></p>
    <div>
      <button onclick="startScanner()">Scan Admin QR Code</button>
      <div id="scanner" style="width: 100%;"></div>
    </div>
    <h3>Today's Logs</h3>
    <table id="todayLogs" border="1" width="100%">
      <thead>
        <tr>
          <th>Time</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="container hidden" id="adminDashboard">
    <h2>Admin Dashboard</h2>
    <p>Scan this QR to Time In/Out</p>
    <div id="adminQR"></div>
    <h3>Logs</h3>
    <table id="logTable" border="1" width="100%">
      <thead>
        <tr>
          <th>Name</th>
          <th>Grade</th>
          <th>Track</th>
          <th>Status</th>
          <th>Time</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    let currentUser = null;
    const logs = JSON.parse(localStorage.getItem("logs") || "[]");

    function register() {
      const name = document.getElementById("name").value;
      const password = document.getElementById("password").value;
      const track = document.getElementById("track").value;
      const strand = document.getElementById("strand").value;
      const grade = document.getElementById("grade").value;
      if (!name || !password || !track || !strand || !grade) return alert("All fields required");
      localStorage.setItem(name, JSON.stringify({ password, track: strand, grade }));
      alert("Registered! You can now log in.");
    }

    function login() {
      const name = document.getElementById("name").value;
      const password = document.getElementById("password").value;

      if (name === "admin" && password === "admin") {
        document.getElementById("authContainer").classList.add("hidden");
        document.getElementById("adminDashboard").classList.remove("hidden");
        generateAdminQR();
        showLogs();
        return;
      }

      const user = JSON.parse(localStorage.getItem(name));
      if (!user || user.password !== password) return alert("Invalid credentials");
      currentUser = { name, ...user };
      document.getElementById("authContainer").classList.add("hidden");
      document.getElementById("studentDashboard").classList.remove("hidden");
      document.getElementById("studentName").innerText = name;
      document.getElementById("studentGrade").innerText = user.grade;
      document.getElementById("studentTrack").innerText = user.track;
      showTodayLogs();
    }

    function startScanner() {
      const scanner = new Html5Qrcode("scanner");
      scanner.start({ facingMode: "environment" }, {
        fps: 10,
        qrbox: 250
      }, qrCodeMessage => {
        if (qrCodeMessage === "admin-qr-identifier") {
          const now = new Date();
          const status = getStatusForToday(currentUser.name) === "Time In" ? "Time Out" : "Time In";
          logs.push({ name: currentUser.name, grade: currentUser.grade, track: currentUser.track, status, time: now.toLocaleTimeString(), date: now.toDateString() });
          localStorage.setItem("logs", JSON.stringify(logs));
          showTodayLogs();
          document.body.classList.add("success");
          setTimeout(() => document.body.classList.remove("success"), 300);
          scanner.stop();
          document.getElementById("scanner").innerHTML = "";
        }
      });
    }

    function generateAdminQR() {
      const qrcode = new QRCode(document.getElementById("adminQR"), {
        text: "admin-qr-identifier",
        width: 200,
        height: 200
      });
    }

    function getStatusForToday(name) {
      const today = new Date().toDateString();
      const userLogs = logs.filter(log => log.name === name && log.date === today);
      if (userLogs.length % 2 === 0) return "Time In";
      return "Time Out";
    }

    function showTodayLogs() {
      const tbody = document.querySelector("#todayLogs tbody");
      tbody.innerHTML = "";
      const today = new Date().toDateString();
      logs.filter(log => log.name === currentUser.name && log.date === today)
          .forEach(log => {
            const row = `<tr><td>${log.time}</td><td>${log.status}</td></tr>`;
            tbody.innerHTML += row;
          });
    }

    function showLogs() {
      const tbody = document.querySelector("#logTable tbody");
      tbody.innerHTML = "";
      logs.forEach(log => {
        const row = `<tr><td>${log.name}</td><td>${log.grade}</td><td>${log.track}</td><td>${log.status}</td><td>${log.time}</td><td>${log.date}</td></tr>`;
        tbody.innerHTML += row;
      });
    }
  </script>
</body>
</html>
